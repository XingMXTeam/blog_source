<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=https://maoxunxing.com/manifest.json><meta name=author content="Xunxing Mao"><meta name=description content="articles about Front-End development and engineering technology including html, css, javascript, nodejs, c, algorithms, software architecture"><meta name=keywords content=blog,developer,personal,毛训星,maoxunxing,front-end,html,css,javascript,nodejs><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@maoxunxing><meta name=twitter:creator content=@maoxunxing><meta property=og:title content="NodeJS Stream from Beginner to Master"><meta property=og:description content="Streams are one of the most difficult and powerful features of nodejs, and this article composes the content of streams"><meta property=og:type content=article><meta property=og:url content=https://maoxunxing.com/zh-cn/nodejs-network-stream/><meta property=og:image content=https://maoxunxing.com/nodejs-network-stream/images.jpeg><meta property=article:published_time content=2021-10-19T14:28:57+08:00><meta property=article:modified_time content=2021-10-19T14:28:57+08:00><meta property=og:site_name content=毛训星的网络日志><base href=https://maoxunxing.com/zh-cn/nodejs-network-stream/><title>NodeJS Stream from Beginner to Master · 毛训星的网络日志</title><link rel=canonical href=https://maoxunxing.com/zh-cn/nodejs-network-stream/><link rel="preconnect dns-prefetch" href=//cdn.jsdelivr.net><link rel="preconnect dns-prefetch" href=//cdnjs.cloudflare.com><link rel=preload as=style rel=stylesheet onload="this.onload=null;this.rel='stylesheet'" href=../css/font.css crossorigin=anonymous><link rel=preload as=style rel=stylesheet onload="this.onload=null;this.rel='stylesheet'" href=https://cdn.jsdelivr.net/npm/normalize.min.css@8.0.1/normalize.min.css integrity="sha256-oeib74n7OcB5VoyaI+aGxJKkNEdyxYjd2m3fi/3gKls=" crossorigin=anonymous><link rel=stylesheet href=https://maoxunxing.com/css/coder.min.8b74f2a917b62bc11fd3bb6cdbb2f369faa9711339338533e3cf2d9997c70b38.css integrity="sha256-i3TyqRe2K8Ef07ts27LzafqpcRM5M4Uz488tmZfHCzg=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://maoxunxing.com/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://maoxunxing.com/css/main.css><link rel=icon type=image/png href=https://maoxunxing.com/images/favicon/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://maoxunxing.com/images/favicon/favicon-16x16.png sizes=16x16><link rel=alternate type=application/rss+xml href=https://maoxunxing.com//index.xml title=毛训星的网络日志><meta name=generator content="Hugo 0.55.4"></head><body class=colorscheme-auto><div class=float-container></div><main class=wrapper><nav class=navigation><section class=container><div class=navigation-author><a class=navigation-avatar href=https://maoxunxing.com/zh-cn><img style=width:50x;height:50px src=https://maoxunxing.com/images/avatar.jpg alt="Author photo"></a>
<a class=name href=https://maoxunxing.com/zh-cn>训星个人站</a></div><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://maoxunxing.com/zh-cn/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://maoxunxing.com/zh-cn/projects/>项目</a></li><li class=navigation-item><a class=navigation-link href=https://maoxunxing.com/zh-cn/book-reports/>读书报告</a></li><li class=navigation-item><a class=navigation-link href=https://maoxunxing.com/zh-cn/about/>关于</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://maoxunxing.com/zh-cn/notes class="router-link-active router-link-exact-active" title=Notes data-v-939756fc aria-current=page><svg class="inline" width="1.2em" height="1.2em" viewBox="0 0 24 24" style="vertical-align:sub"><path d="M21 15l-6 5.996L4.002 21A.998.998.0 0 1 3 20.007V3.993C3 3.445 3.445 3 3.993 3h16.014c.548.0.993.456.993 1.002V15zM19 5H5v14h8v-5a1 1 0 0 1 .883-.993L14 13l5-.001V5zm-.829 9.999L15 15v3.169l3.171-3.17z" fill="currentcolor"/></svg></a></li><li class=navigation-item><a href=https://github.com/XingMXTeam/ target=_blank title=GitHub data-v-939756fc><svg class="inline" width="1.2em" height="1.2em" viewBox="0 0 24 24" style="vertical-align:sub"><path d="M10.07 20.503a1 1 0 0 0-1.18-.983c-1.31.24-2.963.276-3.402-.958a5.708 5.708.0 0 0-1.837-2.415 1.2 1.2.0 0 1-.167-.11 1 1 0 0 0-.93-.645h-.005a1 1 0 0 0-1 .995c-.004.815.81 1.338 1.141 1.514a4.44 4.44.0 0 1 .924 1.36c.365 1.023 1.423 2.576 4.466 2.376l.003.098.004.268a1 1 0 0 0 2 0l-.005-.318c-.005-.19-.012-.464-.012-1.182zM20.737 5.377c.032-.125.063-.264.09-.42a6.278 6.278.0 0 0-.408-3.293 1.002 1.002.0 0 0-.615-.58c-.356-.12-1.67-.357-4.184 1.25a13.87 13.87.0 0 0-6.354.0C6.762.75 5.455.966 5.102 1.079a.997.997.0 0 0-.631.584 6.3 6.3.0 0 0-.404 3.357c.025.127.051.246.079.354a6.27 6.27.0 0 0-1.256 3.83 8.422 8.422.0 0 0 .043.921c.334 4.603 3.334 5.984 5.424 6.459a4.591 4.591.0 0 0-.118.4 1 1 0 0 0 1.942.479 1.678 1.678.0 0 1 .468-.878 1 1 0 0 0-.546-1.745c-3.454-.395-4.954-1.802-5.18-4.899a6.61 6.61.0 0 1-.033-.738 4.258 4.258.0 0 1 .92-2.713 3.022 3.022.0 0 1 .195-.231 1 1 0 0 0 .188-1.025 3.388 3.388.0 0 1-.155-.555 4.094 4.094.0 0 1 .079-1.616 7.543 7.543.0 0 1 2.415 1.18 1.009 1.009.0 0 0 .827.133 11.777 11.777.0 0 1 6.173.001 1.005 1.005.0 0 0 .83-.138 7.572 7.572.0 0 1 2.406-1.19 4.04 4.04.0 0 1 .087 1.578 3.205 3.205.0 0 1-.169.607 1 1 0 0 0 .188 1.025c.078.087.155.18.224.268A4.122 4.122.0 0 1 20 9.203a7.039 7.039.0 0 1-.038.777c-.22 3.056-1.725 4.464-5.195 4.86a1 1 0 0 0-.546 1.746 1.63 1.63.0 0 1 .466.908 3.06 3.06.0 0 1 .093.82v2.333c-.01.648-.01 1.133-.01 1.356a1 1 0 1 0 2 0c0-.217.0-.692.01-1.34v-2.35a4.881 4.881.0 0 0-.155-1.311 4.256 4.256.0 0 0-.116-.416 6.513 6.513.0 0 0 5.445-6.424A8.697 8.697.0 0 0 22 9.203a6.13 6.13.0 0 0-1.263-3.826z" fill="currentcolor"/></svg></a></li><li class=navigation-item><a href=https://www.douban.com/people/maoxingxing/ target=_blank title=douban class=lt-md:hidden data-v-939756fc><svg t="1637423568461" class="icon douban" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="4782" width="1.2em" height="1.2em"><path d="M715.824 611.542h-395.425c42.209 71.089 82.194 148.841 115.519 228.812h162.166c48.875-75.533 88.861-151.06 117.739-228.812zM762.474 524.904V356.071h-486.503v168.833h486.503zM960.187 929.214h-888.596v-86.637H338.17c-33.322-71.089-66.646-133.289-102.189-184.386l68.865-44.427H184.885V267.209h675.334v346.555h-126.623l68.865 44.427c-33.322 71.089-66.646 133.289-99.966 184.386h259.916v86.637zM940.196 165.023H98.25V78.386h841.946v86.637z" fill="currentcolor" p-id="4783"/></svg></a></li><li class=navigation-item><a href=https://twitter.com/maoxunxing/ target=_blank title=Twitter data-v-939756fc><svg class="inline" width="1.2em" height="1.2em" viewBox="0 0 24 24" style="vertical-align:sub"><g fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 0 1-3.14 1.53 4.48 4.48.0 0 0-7.86 3v1A10.66 10.66.0 0 1 3 4s-4 9 5 13a11.64 11.64.0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5.0 0 0-.08-.83A7.72 7.72.0 0 0 23 3z"/></g></svg></a></li><li class=navigation-item><a href=https://maoxunxing.com/en/posts/index.xml target=_blank title=RSS class=lt-md:hidden data-v-939756fc><svg class="inline rss" width="1.2em" height="1.2em" viewBox="0 0 32 32" style="vertical-align:sub;font-size:2rem;margin:0 -.125rem"><path d="M5 5v22h22V5zm2 2h18v18H7zm5 3c-.684.0-1.355.055-2 .188v2.062a7.86 7.86.0 0 1 2-.25c4.41.0 8 3.59 8 8 0 .691-.086 1.36-.25 2h2.063A9.923 9.923.0 0 0 22 20c0-5.516-4.484-10-10-10zm0 4a5.96 5.96.0 0 0-2 .344v2.219A3.968 3.968.0 0 1 12 16c2.207.0 4 1.793 4 4 0 .73-.219 1.41-.563 2h2.22A5.96 5.96.0 0 0 18 20c0-3.309-2.691-6-6-6zm0 4a1.999 1.999.0 1 0 0 4 1.999 1.999.0 1 0 0-4z" fill="currentcolor"/></svg></a></li><li class=navigation-item><a href=javascript:void id=dark-mode-toggle title="Toggle Color Scheme"><svg class="inline dark-mode-icon" width="1.2em" height="1.2em" viewBox="0 0 24 24" style="vertical-align:sub"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979.0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999.0 0 0 4 12z" fill="currentcolor"/></svg><svg class="inline light-mode-icon" width="1.2em" height="1.2em" viewBox="0 0 24 24" style="vertical-align:sub"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85 1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z" fill="currentcolor"/></svg></a></li><li class=navigation-item><a href=https://maoxunxing.com/en/ id=languageMenu>EN</a></li></ul></section></nav><script>window.addEventListener('load',()=>{const menu=document.getElementById('languageMenu')
const arr=location.pathname.split("/");menu.setAttribute('href',menu.getAttribute('href')+(arr.length>=4?arr[arr.length-2]:''))})</script><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>NodeJS Stream from Beginner to Master</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2021-10-19T14:28:57&#43;08:00>October 19, 2021</time></span>
<span class=reading-time><i class="fas fa-clock"></i>12 分钟阅读时间</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://maoxunxing.com/zh-cn/tags/nodejs/>NodeJS</a></div></div></header><div><h2 id=what-is-a-stream>What is a stream<a href=#what-is-a-stream class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h2><p>Streams are not only found in Nodejs, there are similar concepts in unix operating systems. For example, the pipe operation symbol</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat xx.ts | grep <span style=background-color:#fff0f0>&#39;console.log&#39;</span></code></pre></div><p>can find the corresponding matching content from the file. In fact, the concept of streams in node comes from unix systems, first from Douglas McIlroy&rsquo;s concept of pipes <a href=http://cm.bell-labs.co/who/dmr/mdmpipe.html>Initial source</a>。</p><p>Wikipedia：</p><blockquote><p>Malcolm Douglas McIlroy (born 1932) is a mathematician, engineer, and programmer. As of 2019 he is an Adjunct Professor of Computer Science at Dartmouth College. <strong>McIlroy is best known for having originally proposed Unix pipelines</strong> and developed several Unix tools, such as spell, diff, sort, join, graph, speak, and tr.[1] He was also one of the pioneering researchers of macro processors and programming language extensibility. He participated in the design of multiple influential programming languages, particularly PL/I, SNOBOL, ALTRAN, TMG and C++.</p></blockquote><p>Essentially, a stream is a format for data exchange. For example, we are operating on file reading and writing, network transfers, etc. Personally, I think streams are one of the most difficult and powerful features of nodejs to understand.</p><p>Whether streams are relevant to us or not, streams are almost everywhere in nodejs. For example, request streams, response streams, file streams. Do a search for<a href=https://github.com/nodejs/node/blob/863d13c192a8d315fa274194e64c1c9e5820e8f2/lib/internal/console/constructor.js>Node runtime code</a>. Everywhere you look you see.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>...
  <span style=color:#080;font-weight:700>if</span> (ignoreErrors <span style=color:#333>===</span> <span style=color:#080;font-weight:700>false</span>) <span style=color:#080;font-weight:700>return</span> stream.write(string);

      <span style=color:#888>// There may be an error occurring synchronously (e.g. for files or TTYs
</span><span style=color:#888></span>      <span style=color:#888>// on POSIX systems) or asynchronously (e.g. pipes on POSIX systems), so
</span><span style=color:#888></span>      <span style=color:#888>// handle both situations.
</span><span style=color:#888></span>      <span style=color:#080;font-weight:700>try</span> {
        <span style=color:#888>// Add and later remove a noop error handler to catch synchronous
</span><span style=color:#888></span>        <span style=color:#888>// errors.
</span><span style=color:#888></span>        <span style=color:#080;font-weight:700>if</span> (stream.listenerCount(<span style=background-color:#fff0f0>&#39;error&#39;</span>) <span style=color:#333>===</span> <span style=color:#00d;font-weight:700>0</span>)
          stream.once(<span style=background-color:#fff0f0>&#39;error&#39;</span>, noop);

        stream.write(string, errorHandler);
      } <span style=color:#080;font-weight:700>catch</span> (e) {
        <span style=color:#888>// Console is a debugging utility, so it swallowing errors is not
</span><span style=color:#888></span>        <span style=color:#888>// desirable even in edge cases such as low stack space.
</span><span style=color:#888></span>        <span style=color:#080;font-weight:700>if</span> (isStackOverflowError(e))
          <span style=color:#080;font-weight:700>throw</span> e;
        <span style=color:#888>// Sorry, there&#39;s no proper way to pass along the error here.
</span><span style=color:#888></span>      } <span style=color:#080;font-weight:700>finally</span> {
        stream.removeListener(<span style=background-color:#fff0f0>&#39;error&#39;</span>, noop);
...
</code></pre></div><h2 id=how-to-use-streams>How to use streams<a href=#how-to-use-streams class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h2><h3 id=basic-usage>Basic usage<a href=#basic-usage class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><p>This code is familiar to everyone.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> http <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;http&#39;</span>)
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)
<span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> http.createServer(<span style=color:#080;font-weight:700>function</span>(req, res) {
  fs.readFile(__dirname <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39;/data.txt&#39;</span>, (err, data) =&gt; {
    res.end(data)
  })
})
server.listen(<span style=color:#00d;font-weight:700>3000</span>)
</code></pre></div><p>When we read a file inside Nodejs, we read the whole file into memory and then process the contents of this file. What is the problem with this: data.txt is read into memory, which leads to a poor user experience, especially with low networks.
With streams, it is possible to process one fragment at a time, instead of reading it all into memory at once.</p><p>Rewritten by means of streams.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> http <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;http&#39;</span>)
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)
<span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> http.createServer(<span style=color:#080;font-weight:700>function</span>(req, res) {
  <span style=color:#080;font-weight:700>const</span> stream <span style=color:#333>=</span> fs.createReadStream(__dirname <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39;/data.txt&#39;</span>);
  stream.pipe(res)
})
server.listen(<span style=color:#00d;font-weight:700>3000</span>)
</code></pre></div><p>Here pipe does two things:
1 is listening to the data
2 is equivalent to calling res.end which automatically manages the caching of data fragments</p><p>We can even do data compression:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> http <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;http&#39;</span>)
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)
<span style=color:#080;font-weight:700>const</span> oppressor <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;oppressor&#39;</span>)

<span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> http.createServer(<span style=color:#080;font-weight:700>function</span>(req, res) {
  <span style=color:#080;font-weight:700>const</span> stream <span style=color:#333>=</span> fs.createReadStream(__dirname <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39;/data.txt&#39;</span>);
  stream.pipe(oppressor(req)).pipe(res)
})
server.listen(<span style=color:#00d;font-weight:700>3000</span>)
</code></pre></div><h3 id=types-of-streams>Types of streams<a href=#types-of-streams class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><p>1 readable readable <code>readable.pipe(A)</code>
2 writable writable <code>A.pipe(writable)</code>
3 duplex: multiplex: both readable and writable <code>A.pipe(duplex).pipe(A)</code>
4 transform: a type of duplex readable and writable output is transformed from input <code>A.pipe(transform).pipe(B)</code></p><p>pipe method:
All readable/transform/duplex streams have this method, and return readable/transform/duplex streams</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>src.pipe(dst) <span style=color:#888>// 返回一个可读的流 所以可以链式调用 和unix的管道操作符是一样的 比如 cat xx.txt | grep &#39;console&#39;
</span></code></pre></div><p>Common methods for readable streams.</p><ul><li>`<code>stream.pipe(...)</code></li><li>`<code>stream.once('end', function() {})</code><br></li></ul><p>Two modes: the default is pause mode, which means you need to call the next/read method manually and can turn on flow mode</p><ul><li><code>stream.resume()</code></li><li><code>stream.on('data', function(buf) {})</code> The binding will automatically trigger flow mode</li></ul><p>The data stream of the resource does not flow directly to the consumer, but first pushes to the cache pool, with a water level, and if it exceeds this level, the push returns false: for example</p><ul><li>the consumer actively performs a .pause()</li><li>the consumption rate is slower than the production rate of the data pushed to the cache pool</li></ul><p>Both will return false, which is also called &ldquo;backpressure&rdquo;.</p><p>Common methods for writable streams.</p><ul><li><code>.write(buf)</code></li><li><code>.end()</code></li><li><code>.end(buf)</code></li><li><code>.on('finish', function() {})</code></li><li>(&hellip;) .pipe(stream)</li></ul><p>The stream goes to the resource pool first, if the write is slow or paused, it will be cached; if it is too fast, write will return false, triggering the drain event</p><p>transform/duplex streams can use all the above methods</p><h3 id=create-a-readable-stream-readable-js-readable-js>Create a readable stream: <a href=". /readable.js">readable.js</a><a href=#create-a-readable-stream-readable-js-readable-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> rs <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> (require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>).Readable);
rs.push(<span style=background-color:#fff0f0>&#39;beep&#39;</span>);
rs.push(<span style=color:#080;font-weight:700>null</span>); <span style=color:#888>// null tells the consumer that the data is finished
</span><span style=color:#888></span>rs.pipe(process.stdout);
</code></pre></div><h3 id=create-a-writeable-stream-writeable-js-writable-js>Create a writeable stream: <a href=". /writable.js">writeable.js</a><a href=#create-a-writeable-stream-writeable-js-writable-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> Stream <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> writableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Writable(({
  decodeString<span style=color:#333>:</span> <span style=color:#080;font-weight:700>false</span>,
  write(chunk, encoding, next) { <span style=color:#888>// Called when writing
</span><span style=color:#888></span>    console.log(chunk.toString())
    next();<span style=color:#888>// tell to read more data
</span><span style=color:#888></span>  }
}))
process.stdin.pipe(writableStream)
</code></pre></div><h3 id=consume-a-readable-stream-consume0-js-consume0-js>Consume a readable stream: <a href=". /consume0.js">consume0.js</a><a href=#consume-a-readable-stream-consume0-js-consume0-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>//(echo abc; sleep 1; echo def; sleep 1; echo ghi) | node consume0.js 
</span><span style=color:#888></span>process.stdin.on(<span style=background-color:#fff0f0>&#39;readable&#39;</span>, <span style=color:#080;font-weight:700>function</span> () {
    <span style=color:#080;font-weight:700>var</span> buf <span style=color:#333>=</span> process.stdin.read();<span style=color:#888>// 可以给read传参数 告知读取几个字节
</span><span style=color:#888></span>    console.dir(buf);<span style=color:#888>// 打印对象所有属性
</span><span style=color:#888></span>    process.stdin.read(<span style=color:#00d;font-weight:700>0</span>); <span style=color:#888>/// 0告知读取后续的所有字节
</span><span style=color:#888></span>});
<span style=color:#888>//output:
</span><span style=color:#888>//&lt;Buffer 61 62 63 0a&gt; abc\0
</span><span style=color:#888>//&lt;Buffer 64 65 66 0a&gt; def\0
</span><span style=color:#888>//&lt;Buffer 67 68 69 0a&gt; ghi\0
</span></code></pre></div><p>你也可以在消费者读取数据的时候，再缓存内容: <a href=./read1.js>read1.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> rs <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> (require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>).Readable);

<span style=color:#080;font-weight:700>let</span> c <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>97</span>
rs._read <span style=color:#333>=</span> <span style=color:#080;font-weight:700>function</span>() { <span style=color:#888>// 当读取的时候会调用
</span><span style=color:#888></span>  rs.push(<span style=color:#007020>String</span>.fromCharCode(c<span style=color:#333>++</span>))
  <span style=color:#080;font-weight:700>if</span>(c <span style=color:#333>&gt;</span> <span style=background-color:#fff0f0>&#39;z&#39;</span>.charCodeAt(<span style=color:#00d;font-weight:700>0</span>)) rs.push(<span style=color:#080;font-weight:700>null</span>)
}

rs.pipe(process.stdout)


process.on(<span style=background-color:#fff0f0>&#39;exit&#39;</span>, <span style=color:#080;font-weight:700>function</span> () {
  console.error(<span style=background-color:#fff0f0>&#39;\n_read() called &#39;</span> <span style=color:#333>+</span> (c <span style=color:#333>-</span> <span style=color:#00d;font-weight:700>97</span>) <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39; times&#39;</span>);
});
</code></pre></div><p>Reading data from readable streams：<a href=./read2.js>read2.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> Stream <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>)

<span style=color:#080;font-weight:700>const</span> readableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Readable({
  read() {}
})
<span style=color:#080;font-weight:700>const</span> writableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Writable()

writableStream._write <span style=color:#333>=</span> (chunk, encoding, next) =&gt; {
  console.log(chunk.toString())
  next()
}

readableStream.pipe(writableStream)
<span style=color:#888>// or 因为所有的类都继承自EventEmitter， 所有自带一些基本的事件，比如（close...） 和扩展的事件
</span><span style=color:#888>// readableStream.on(&#39;readable&#39;, () =&gt; {
</span><span style=color:#888>//   console.log(readableStream.read().toString())
</span><span style=color:#888>// })
</span><span style=color:#888></span>
readableStream.push(<span style=background-color:#fff0f0>&#39;hi!&#39;</span>)
readableStream.push(<span style=background-color:#fff0f0>&#39;ho!&#39;</span>)
</code></pre></div><h3 id=writing-data-to-a-writable-stream-write1-js-write1-js>Writing data to a writable stream： <a href=./write1.js>write1.js</a><a href=#writing-data-to-a-writable-stream-write1-js-write1-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> Stream <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> writableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Writable()

<span style=color:#888>// var fs = require(&#39;fs&#39;);
</span><span style=color:#888>// var ws = fs.createWriteStream(&#39;message.txt&#39;);
</span><span style=color:#888></span>writableStream.write(<span style=background-color:#fff0f0>&#39;hey!\n&#39;</span>)
</code></pre></div><h3 id=how-to-turn-off-the-stream-close1-js-close1-js>How to turn off the stream： <a href=./close1.js>close1.js</a><a href=#how-to-turn-off-the-stream-close1-js-close1-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> Stream <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>)

<span style=color:#080;font-weight:700>const</span> readableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Readable({
  read() {}
})
<span style=color:#080;font-weight:700>const</span> writableStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Stream.Writable()

writableStream._write <span style=color:#333>=</span> (chunk, encoding, next) =&gt; {
  console.log(chunk.toString())
  next()
}

writableStream.on(<span style=background-color:#fff0f0>&#39;error&#39;</span>, (err) =&gt; {
  console.log(err)
})

readableStream.pipe(writableStream)

readableStream.push(<span style=background-color:#fff0f0>&#39;hi!&#39;</span>)
readableStream.push(<span style=background-color:#fff0f0>&#39;ho!&#39;</span>)

readableStream.on(<span style=background-color:#fff0f0>&#39;close&#39;</span>, () =&gt; {
  writableStream.end()
  <span style=color:#888>// writableStream.write(&#39;111&#39;) 关闭后再写会触发error事件。
</span><span style=color:#888></span>})<span style=color:#888>// 关闭可写流。
</span><span style=color:#888></span>writableStream.on(<span style=background-color:#fff0f0>&#39;close&#39;</span>, () =&gt; console.log(<span style=background-color:#fff0f0>&#39;ended&#39;</span>))

readableStream.destroy() <span style=color:#888>// 销毁可读流。 触发close事件
</span></code></pre></div><h3 id=how-to-create-a-transforms-stream-transform-js-transform-js>How to create a transforms stream： <a href=./transform.js>transform.js</a><a href=#how-to-create-a-transforms-stream-transform-js-transform-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> { Transform } <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> TransformStream <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> Transform(({
  transform(chunk, encoding, callback) {
    <span style=color:#080;font-weight:700>this</span>.push(chunk.toString().toUpperCase())
    callback()
  }
}));

process.stdin.pipe(TransformStream).pipe(process.stdout)
</code></pre></div><p>Generally, to reduce each instantiation, we will use through2: through2.js</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>// node through2.js hello.txt
</span><span style=color:#888></span><span style=color:#080;font-weight:700>const</span> f <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)
<span style=color:#080;font-weight:700>const</span> through <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;through2&#39;</span>)
fs.createReadStream(process.argv[<span style=color:#00d;font-weight:700>2</span>]).pipe(toUpper()).pipe(process.stdout)

<span style=color:#080;font-weight:700>function</span> toUpper() {
  <span style=color:#080;font-weight:700>return</span> through(<span style=color:#080;font-weight:700>function</span>(chunk, enc, next) {
    next(<span style=color:#080;font-weight:700>null</span>, chunk.toString().toUpperCase())
    <span style=color:#888>// or 两个是等价的
</span><span style=color:#888></span>    <span style=color:#888>// this.push(chunk.toString().toUpperCase())
</span><span style=color:#888></span>    <span style=color:#888>// next()
</span><span style=color:#888></span>  })
}
</code></pre></div><h3 id=how-to-create-a-duplex-stream-duplex-js-duplex-js>How to create a duplex stream： <a href=./duplex.js>duplex.js</a><a href=#how-to-create-a-duplex-stream-duplex-js-duplex-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>// nc localhost 8000
</span><span style=color:#888></span><span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>) <span style=color:#888>// create tcp server
</span><span style=color:#888></span>net.createServer(<span style=color:#080;font-weight:700>function</span>(stream) {
  stream.pipe(stream)
}).listen(<span style=color:#00d;font-weight:700>8000</span>)
</code></pre></div><p>A complex example. We can create a proxy server that forwards a bit in between (kind of like a vpn)：duplex2.js</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>// nc localhost 8001 结果是通过8000服务器转发的
</span><span style=color:#888></span><span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>) <span style=color:#888>// create tcp server
</span><span style=color:#888></span>net.createServer(<span style=color:#080;font-weight:700>function</span>(stream) {
  stream.pipe(net.connect(<span style=color:#00d;font-weight:700>8000</span>, <span style=background-color:#fff0f0>&#39;localhost&#39;</span>)).pipe(stream)
}).listen(<span style=color:#00d;font-weight:700>8001</span>)
</code></pre></div><h3 id=object-stream-object-js-object-js>Object Stream <a href=./object.js>object.js</a><a href=#object-stream-object-js-object-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><p>Normally, you can only read and write buffers (like text files) and strings. If you want to read objects, the
you need to enable object mode</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> through <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;through2&#39;</span>)
<span style=color:#080;font-weight:700>const</span> tr <span style=color:#333>=</span> through.obj(<span style=color:#080;font-weight:700>function</span>(row, enc, next) {
  next(<span style=color:#080;font-weight:700>null</span>, (row.n <span style=color:#333>*</span> <span style=color:#00d;font-weight:700>1000</span>) <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39;\n&#39;</span>)
})
tr.pipe(process.stdout)
tr.write({ n<span style=color:#333>:</span> <span style=color:#00d;font-weight:700>5</span> })
tr.write({ n<span style=color:#333>:</span> <span style=color:#00d;font-weight:700>10</span> })
tr.write({ n<span style=color:#333>:</span> <span style=color:#00d;font-weight:700>3</span> })
tr.end()
</code></pre></div><h3 id=how-to-cache-streams-for-one-time-reading-concat-js-concat-js>How to cache streams for one-time reading： <a href=./concat.js>concat.js</a><a href=#how-to-cache-streams-for-one-time-reading-concat-js-concat-js class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> concat <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;concat-stream&#39;</span>)
process.stdin.pipe(concat(<span style=color:#080;font-weight:700>function</span>(body) {
    console.log(body.length) <span style=color:#888>//ctr+d 会一次性打印出来
</span><span style=color:#888></span>}))
</code></pre></div><p>complex scenarios. For example, we need to determine the length of the request parameters: <a href=./concat2.js>concat2.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>// curl -d msg=hello localhost:6000
</span><span style=color:#888></span><span style=color:#080;font-weight:700>const</span> concat <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;concat-stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> http <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;http&#39;</span>)
<span style=color:#080;font-weight:700>const</span> qs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;querystring&#39;</span>)
<span style=color:#080;font-weight:700>const</span> through <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;through2&#39;</span>)
<span style=color:#080;font-weight:700>function</span> counter() {
  <span style=color:#080;font-weight:700>let</span> size <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>
  <span style=color:#080;font-weight:700>return</span> through(<span style=color:#080;font-weight:700>function</span>(buf, enc, next) {
    size <span style=color:#333>+=</span> buf.length
    <span style=color:#080;font-weight:700>if</span>(size <span style=color:#333>&gt;</span> <span style=color:#00d;font-weight:700>20</span>) next(<span style=color:#080;font-weight:700>null</span>, <span style=color:#080;font-weight:700>null</span>) <span style=color:#888>// 终止流
</span><span style=color:#888></span>    <span style=color:#080;font-weight:700>else</span> next(<span style=color:#080;font-weight:700>null</span>, buf)
  })
}

<span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> http.createServer(<span style=color:#080;font-weight:700>function</span>(req, res) {
    req
    .pipe(counter())
    .pipe(concat({ encoding<span style=color:#333>:</span> <span style=background-color:#fff0f0>&#39;string&#39;</span> }, <span style=color:#080;font-weight:700>function</span>(body) {
        <span style=color:#080;font-weight:700>const</span> params <span style=color:#333>=</span> qs.parse(body) <span style=color:#888>// 读取的是空
</span><span style=color:#888></span>        console.log(params)
        res.end(<span style=background-color:#fff0f0>&#39;ok\n&#39;</span>)
    }))
})

server.listen(<span style=color:#00d;font-weight:700>6000</span>)
</code></pre></div><h3 id=built-in-streams>Built-in streams<a href=#built-in-streams class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><ul><li>process.stdin: Readable streams</li><li>process.stdout：Writable streams</li><li>process.stderr：Writable streams</li><li>fs.createReadStream()</li><li>fs.createWriteStream()</li><li>net.connect()： Duplex streams, for establishing tcp connections</li><li>net.createServer()</li><li>http.request()</li><li>http.createServer()</li><li>zlib.createGzip()</li><li>zlib.createGunzip() : gzip decompression</li><li>zlib.createDeflate(): Compression with deflate algorithm</li><li>zlib.createInflate(): Decompress with deflate algorithm</li><li>tls.connect()</li><li>tls.createServer()</li><li>child_process spawn: Create a new process</li></ul><p>Other commonly used streaming modules.</p><ul><li>crypto: encryption</li><li>zlib: compression</li><li>split2: return data by line, e.g. read a file</li><li>websocket-stream</li><li>collect-stream</li><li>from2: direct to readable stream</li><li>to2: direct to writable streams</li><li>duplexify: supports converting streams to duplex types</li><li>pump</li><li>pumpify</li><li>end-of-stream: determines if the stream has ended, receives a callback function</li></ul><h4 id=collect-stream>collect-stream<a href=#collect-stream class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=./collect.js>collect.js</a></p><p>The same thing as <code>concat-stream</code> , except it has exception handling. Can be used for unit testing</p><h4 id=duplexify>duplexify<a href=#duplexify class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=./duplify.js>duplify.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> duplexify <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;duplexify&#39;</span>)
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)

<span style=color:#080;font-weight:700>function</span> log() {
	<span style=color:#080;font-weight:700>const</span> d <span style=color:#333>=</span> duplexify();
  <span style=color:#080;font-weight:700>var</span> w <span style=color:#333>=</span> fs.createWriteStream(<span style=background-color:#fff0f0>&#39;logs/test.log&#39;</span>)
  d.setWritable(w)
  <span style=color:#080;font-weight:700>return</span> d
}

<span style=color:#080;font-weight:700>const</span> stream <span style=color:#333>=</span> log();
stream.write(<span style=color:#007020>Date</span>.now() <span style=color:#333>+</span> <span style=background-color:#fff0f0>&#39;\n&#39;</span>)
stream.end();
concat<span style=color:#333>-</span>stream
</code></pre></div><p>How to cache the stream for a one-time read: Output the stream as a buffer; if it is an object, it is an array of objects.</p><p>Normal implementation.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>function</span> ResponseReader(encoding) {
  stream.Transform.call(<span style=color:#080;font-weight:700>this</span>);
  <span style=color:#080;font-weight:700>this</span>._chuncks <span style=color:#333>=</span> [];
  <span style=color:#080;font-weight:700>this</span>._encoding <span style=color:#333>=</span> encoding;
}
util.inherits(ResponseReader, stream.Transform);

ResponseReader.prototype._transform <span style=color:#333>=</span> <span style=color:#080;font-weight:700>function</span>(chunk, encoding, callback) {
  <span style=color:#080;font-weight:700>this</span>._chuncks.push(chunk);
  callback();
};

ResponseReader.prototype._flush  <span style=color:#333>=</span> <span style=color:#080;font-weight:700>function</span>(callback) {
  <span style=color:#080;font-weight:700>this</span>.push(Buffer.concat(<span style=color:#080;font-weight:700>this</span>._chuncks).toString(<span style=color:#080;font-weight:700>this</span>._encoding));
  callback();
};
 concat.js

<span style=color:#080;font-weight:700>const</span> concat <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;concat-stream&#39;</span>)
process.stdin.pipe(concat(<span style=color:#080;font-weight:700>function</span>(body) {
    console.log(body.length) <span style=color:#888>//ctr+d 会一次性打印出来
</span><span style=color:#888></span>}))
</code></pre></div><p>Complex scenarios. For example, we respond by returning complete data (such as an image) before proceeding to the next operation
<a href=./concat2.js>concat2.js</a></p><p>// curl -d msg=hello localhost:6000</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> concat <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;concat-stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> http <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;http&#39;</span>)
<span style=color:#080;font-weight:700>const</span> qs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;querystring&#39;</span>)
<span style=color:#080;font-weight:700>const</span> through <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;through2&#39;</span>)
<span style=color:#080;font-weight:700>function</span> counter() {
  <span style=color:#080;font-weight:700>let</span> size <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>
  <span style=color:#080;font-weight:700>return</span> through(<span style=color:#080;font-weight:700>function</span>(buf, enc, next) {
    size <span style=color:#333>+=</span> buf.length
    <span style=color:#080;font-weight:700>if</span>(size <span style=color:#333>&gt;</span> <span style=color:#00d;font-weight:700>20</span>) next(<span style=color:#080;font-weight:700>null</span>, <span style=color:#080;font-weight:700>null</span>) <span style=color:#888>// 需要判断请求参数的长度: 超过20 则终止流
</span><span style=color:#888></span>    <span style=color:#080;font-weight:700>else</span> next(<span style=color:#080;font-weight:700>null</span>, buf)
  })
}

<span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> http.createServer(<span style=color:#080;font-weight:700>function</span>(req, res) {
    req
    .pipe(counter())
    .pipe(concat({ encoding<span style=color:#333>:</span> <span style=background-color:#fff0f0>&#39;string&#39;</span> }, <span style=color:#080;font-weight:700>function</span>(body) {
        <span style=color:#080;font-weight:700>const</span> params <span style=color:#333>=</span> qs.parse(body) <span style=color:#888>// 读取的是空
</span><span style=color:#888></span>        console.log(params)
        res.end(<span style=background-color:#fff0f0>&#39;ok\n&#39;</span>)
    }))
})

server.listen(<span style=color:#00d;font-weight:700>6000</span>)
</code></pre></div><h4 id=pump>pump<a href=#pump class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>Solve the problem that before nodejs version 10.x, when the target stream is destroyed, the source stream is not automatically destroyed and there is no callback. Handle exceptions</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>var</span> pump <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;pump&#39;</span>)
<span style=color:#080;font-weight:700>var</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)

<span style=color:#080;font-weight:700>var</span> source <span style=color:#333>=</span> fs.createReadStream(<span style=background-color:#fff0f0>&#39;/dev/random&#39;</span>)
<span style=color:#080;font-weight:700>var</span> dest <span style=color:#333>=</span> fs.createWriteStream(<span style=background-color:#fff0f0>&#39;/dev/null&#39;</span>)

<span style=color:#888>// source.pipe(dst) 但是会有异常函数回调
</span><span style=color:#888></span>pump(source, dest, <span style=color:#080;font-weight:700>function</span>(err) {
  console.log(<span style=background-color:#fff0f0>&#39;pipe finished&#39;</span>, err)
})

setTimeout(<span style=color:#080;font-weight:700>function</span>() {
  dest.destroy() <span style=color:#888>// when dest is closed pump will destroy source
</span><span style=color:#888></span>}, <span style=color:#00d;font-weight:700>1000</span>)
</code></pre></div><p>After version 10.x you can use <code>pipeline</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> { pipeline } <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>);
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>);
<span style=color:#080;font-weight:700>const</span> zlib <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;zlib&#39;</span>);

<span style=color:#888>// Use the pipeline API to easily pipe a series of streams
</span><span style=color:#888>// together and get notified when the pipeline is fully done.
</span><span style=color:#888></span>
<span style=color:#888>// A pipeline to gzip a potentially huge tar file efficiently:
</span><span style=color:#888></span>
pipeline(
  fs.createReadStream(<span style=background-color:#fff0f0>&#39;archive.tar&#39;</span>),
  zlib.createGzip(),
  fs.createWriteStream(<span style=background-color:#fff0f0>&#39;archive.tar.gz&#39;</span>),
  (err) =&gt; {
    <span style=color:#080;font-weight:700>if</span> (err) {
      console.error(<span style=background-color:#fff0f0>&#39;Pipeline failed.&#39;</span>, err);
    } <span style=color:#080;font-weight:700>else</span> {
      console.log(<span style=background-color:#fff0f0>&#39;Pipeline succeeded.&#39;</span>);
    }
  }
);
</code></pre></div><h4 id=pumpify>pumpify<a href=#pumpify class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>The combination of <code>pump</code> and <code>duplexify</code> will return a duplex stream</p><h4 id=rpc-stream>rpc-stream<a href=#rpc-stream class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>RPC（Remote Procedure Call）中文名『远程过程调用』</p><p>It is actually a call to a function on another machine. For example, our group&rsquo;s HSF is actually a remote call. The source code is well worth reading about how to design a good interface.</p><p><a href=./rpc-server.js>rpc-server.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> rpc <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;rpc-stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>)

net.createServer(<span style=color:#080;font-weight:700>function</span> (stream) {
  <span style=color:#080;font-weight:700>const</span> server <span style=color:#333>=</span> rpc({ <span style=color:#888>// duplex类型
</span><span style=color:#888></span>    hello<span style=color:#333>:</span> <span style=color:#080;font-weight:700>function</span> (name, cb) {
      cb(<span style=color:#080;font-weight:700>null</span>, <span style=background-color:#fff0f0>&#39;hello, &#39;</span> <span style=color:#333>+</span> name)
    }
  })
  server.pipe(stream).pipe(server) <span style=color:#888>//需要传递给server
</span><span style=color:#888></span>}).listen(<span style=color:#00d;font-weight:700>8001</span>)
</code></pre></div><p><a href=./rpc-client.js>rpc-client.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> rpc <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;rpc-stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>)

<span style=color:#080;font-weight:700>const</span> client <span style=color:#333>=</span> rpc()
client.pipe(net.connect(<span style=color:#00d;font-weight:700>8001</span>, <span style=background-color:#fff0f0>&#39;localhost&#39;</span>)).pipe(client) <span style=color:#888>// 需要再次pipe(client)
</span><span style=color:#888></span>
<span style=color:#080;font-weight:700>const</span> remote <span style=color:#333>=</span> client.wrap([<span style=background-color:#fff0f0>&#39;hello&#39;</span>])

remote.hello(<span style=background-color:#fff0f0>&#39;JIM&#39;</span>, <span style=color:#080;font-weight:700>function</span> (err, mess) {
  <span style=color:#080;font-weight:700>if</span>(err) <span style=color:#080;font-weight:700>throw</span> err
  console.log(mess)
})
</code></pre></div><p>Using rpc protocol does not require json format. This is an advantage.</p><h4 id=multiplex>multiplex<a href=#multiplex class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>Ability to package multiple streams into a single stream <a href=./mul1.js>mul1.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>)
<span style=color:#080;font-weight:700>const</span> multiplex <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;multiplex&#39;</span>)
<span style=color:#080;font-weight:700>const</span> rpc <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;rpc-stream&#39;</span>)
<span style=color:#080;font-weight:700>const</span> fs <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;fs&#39;</span>)

net.createServer(<span style=color:#080;font-weight:700>function</span> (stream) {
  <span style=color:#080;font-weight:700>const</span> plex <span style=color:#333>=</span> multiplex()
  stream.pipe(plex).pipe(stream);
  <span style=color:#080;font-weight:700>const</span> client <span style=color:#333>=</span> rpc({
    read<span style=color:#333>:</span> <span style=color:#080;font-weight:700>function</span>(name , cb) {
      <span style=color:#080;font-weight:700>if</span>(<span style=color:#333>!</span><span style=color:#000;background-color:#fff0ff>/^[\w-]+$/</span>.test(name)) {
        <span style=color:#080;font-weight:700>return</span> cb(<span style=color:#080;font-weight:700>new</span> <span style=color:#007020>Error</span>(<span style=background-color:#fff0f0>&#39;file not allowed&#39;</span>))
      }
      <span style=color:#080;font-weight:700>const</span> r <span style=color:#333>=</span> fs.createReadStream(<span style=background-color:#fff0f0>&#39;files/&#39;</span> <span style=color:#333>+</span> name)
      r.on(<span style=background-color:#fff0f0>&#39;error&#39;</span>, cb)
      r.pipe(plex.createStream(<span style=background-color:#fff0f0>&#39;file-&#39;</span><span style=color:#333>+</span>name)).pipe(r)
      cb(<span style=color:#080;font-weight:700>null</span>)
    }
  })
  client.pipe(plex.createSharedStream(<span style=background-color:#fff0f0>&#39;rpc&#39;</span>)).pipe(client)
}).listen(<span style=color:#00d;font-weight:700>8000</span>)
<span style=color:#888>//node mul1-client.js hello
</span><span style=color:#888></span><span style=color:#080;font-weight:700>const</span> net <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;net&#39;</span>)
<span style=color:#080;font-weight:700>const</span> multiplex <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;multiplex&#39;</span>)
<span style=color:#080;font-weight:700>const</span> rpc <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;rpc-stream&#39;</span>)

<span style=color:#080;font-weight:700>const</span> plex <span style=color:#333>=</span> multiplex(<span style=color:#080;font-weight:700>function</span>(stream, id) {
  <span style=color:#080;font-weight:700>if</span>(<span style=color:#000;background-color:#fff0ff>/^file-/</span>.test(id)) {
    console.log(<span style=background-color:#fff0f0>&#39;reveived file &#39;</span> <span style=color:#333>+</span> id.replace(<span style=color:#000;background-color:#fff0ff>/^file-/</span>, <span style=background-color:#fff0f0>&#39;&#39;</span>))
    stream.pipe(process.stdout)
  }
})

plex.pipe(net.connect(<span style=color:#00d;font-weight:700>8000</span>)).pipe(plex)

<span style=color:#080;font-weight:700>const</span> client <span style=color:#333>=</span> rpc()
client.pipe(plex.createSharedStream(<span style=background-color:#fff0f0>&#39;rpc&#39;</span>)).pipe(client)
<span style=color:#080;font-weight:700>const</span> remote <span style=color:#333>=</span> client.wrap([<span style=background-color:#fff0f0>&#39;read&#39;</span>])
remote.read(process.argv[<span style=color:#00d;font-weight:700>2</span>], <span style=color:#080;font-weight:700>function</span>(err) {
  <span style=color:#080;font-weight:700>if</span>(err) console.error(err)
})
</code></pre></div><h3 id=practical-application-scenarios>Practical application scenarios<a href=#practical-application-scenarios class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><h4 id=1-file-download-import-export>1 File download/import/export<a href=#1-file-download-import-export class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=https://www.eggjs.org/api/node_modules_egg-multipart_app_extend_context.js.html>https://www.eggjs.org/api/node_modules_egg-multipart_app_extend_context.js.html</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>const</span> {
    ctx,
} <span style=color:#333>=</span> <span style=color:#080;font-weight:700>this</span>;
<span style=color:#080;font-weight:700>const</span> parts <span style=color:#333>=</span> ctx.multipart();
<span style=color:#080;font-weight:700>let</span> object;
<span style=color:#080;font-weight:700>let</span> part;
part <span style=color:#333>=</span> <span style=color:#080;font-weight:700>yield</span> parts;
<span style=color:#080;font-weight:700>while</span> (part) {
    <span style=color:#080;font-weight:700>if</span> (part.length) {
        <span style=color:#888>// arrays are busboy fields
</span><span style=color:#888></span>    } <span style=color:#080;font-weight:700>else</span> {
        <span style=color:#888>// otherwise, it&#39;s a stream
</span><span style=color:#888></span>        <span style=color:#888>// 文件处理，上传到云存储等等
</span><span style=color:#888></span>        object <span style=color:#333>=</span> <span style=color:#080;font-weight:700>yield</span> ctx.oss.put(<span style=background-color:#fff0f0>&#39;egg-oss-demo-&#39;</span> <span style=color:#333>+</span> part.filename, part);
    }
    part <span style=color:#333>=</span> <span style=color:#080;font-weight:700>yield</span> parts;
}
</code></pre></div><h4 id=2-network-transfer>2 Network transfer<a href=#2-network-transfer class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>eg. downloading files from a remote location</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>yield</span> <span style=color:#080;font-weight:700>new</span> <span style=color:#007020>Promise</span>((resolve, reject)=&gt;{
  ctx.safeCurl(whitelistExcelLink).then(response =&gt; {
    <span style=color:#080;font-weight:700>const</span> data <span style=color:#333>=</span> response.data;
    <span style=color:#080;font-weight:700>const</span> stream <span style=color:#333>=</span> fs.createWriteStream(filepath)
    stream.write(data, () =&gt; {
      resolve <span style=color:#333>&amp;&amp;</span> resolve()
    });
  }).<span style=color:#080;font-weight:700>catch</span>(e =&gt; {
    ctx.logger.error(e)
  });
}); 
</code></pre></div><h4 id=3-vpn>3 vpn<a href=#3-vpn class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=./vpn-client.js>vpn-client.js</a>
<a href=./vpn-server.js>vpn-server.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>node vpn-client.js
node vpn-server.js
node echo.js</code></pre></div><h4 id=4-real-time-communication>4 Real-time communication<a href=#4-real-time-communication class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=./websocket-client.js>websocket-client.js</a>
<a href=./websocket-server.js>websocket-server.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>browserify websocket-client.js &gt; public/bundle.js <span style=color:#333>(</span>或者nodejs client也行）
node websocket-server.js</code></pre></div><p>Question： websocket和<a href=https://github.com/socketio/socket.io/blob/master/lib/index.ts>socket.io</a>的区别？</p><h4 id=5-p2p>5 p2p<a href=#5-p2p class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p>Peer-to-peer (P2P) services are a decentralized platform where two people interact directly with each other without a third party intermediary。<a href=./webrtc.js>webrtc.js</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tnpm run signalhub
budo webrtc.js</code></pre></div><p>Question: Is <a href=https://discord.com/>discord</a> peer-to-peer?</p><h4 id=6-engineering>6 Engineering<a href=#6-engineering class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><blockquote><p>gulp requires frequent manipulation of files</p></blockquote><h4 id=7-webassembly>7 webassembly<a href=#7-webassembly class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h4><p><a href=https://developers.google.com/web/updates/2018/04/loading-wasm>https://developers.google.com/web/updates/2018/04/loading-wasm</a></p><h3 id=read-more>Read More<a href=#read-more class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h3><p>1 Custom implementation</p><p>Implement a writable stream
This can be used to customize the timing of stream writes, so that when the chunk size exceeds a certain threshold, the file is actually written, increasing the write speed</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#888>// strace -cfe trace=write node index.js
</span><span style=color:#888></span><span style=color:#080;font-weight:700>var</span> Writable <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>).Writable;
<span style=color:#080;font-weight:700>var</span> util <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;util&#39;</span>);

<span style=color:#080;font-weight:700>function</span> MyWritable(options) {
    Writable.call(<span style=color:#080;font-weight:700>this</span>, options);
} <span style=color:#888>// 构造函数
</span><span style=color:#888></span>util.inherits(MyWritable, Writable); <span style=color:#888>// 继承自Writable
</span><span style=color:#888></span>MyWritable.prototype._write <span style=color:#333>=</span> <span style=color:#080;font-weight:700>function</span>(chunk, encoding, callback) {
    console.log(<span style=background-color:#fff0f0>&#34;被写入的数据是:&#34;</span>, chunk.toString()); <span style=color:#888>// 此处可对写入的数据进行处理
</span><span style=color:#888></span>    <span style=color:#888>//this.data.push(chunk); 先缓存
</span><span style=color:#888></span>    callback();<span style=color:#888>// 最终写入
</span><span style=color:#888></span>};
process.stdin.pipe(<span style=color:#080;font-weight:700>new</span> MyWritable()); <span style=color:#888>// stdin作为输入源，MyWritable作为输出源
</span><span style=color:#888></span>实现一个readable流
<span style=color:#080;font-weight:700>const</span> Readable <span style=color:#333>=</span> require(<span style=background-color:#fff0f0>&#39;stream&#39;</span>).Readable;

<span style=color:#888>// Stream 实现
</span><span style=color:#888></span><span style=color:#080;font-weight:700>class</span> MyReadable <span style=color:#080;font-weight:700>extends</span> Readable {
  constructor(dataSource, options) {
    <span style=color:#080;font-weight:700>super</span>(options);
    <span style=color:#080;font-weight:700>this</span>.dataSource <span style=color:#333>=</span> dataSource;
  }
  <span style=color:#888>// 继承了 Readable 的类必须实现这个函数
</span><span style=color:#888></span>  <span style=color:#888>// 触发系统底层对流的读取
</span><span style=color:#888></span>  _read() {
    <span style=color:#080;font-weight:700>const</span> data <span style=color:#333>=</span> <span style=color:#080;font-weight:700>this</span>.dataSource.makeData();
    <span style=color:#080;font-weight:700>this</span>.push(data);
  }
}
</code></pre></div><p>Implementing <code>pipe</code></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>Readable.prototype.pipe <span style=color:#333>=</span> <span style=color:#080;font-weight:700>function</span>(writable, options) {
  <span style=color:#080;font-weight:700>this</span>.on(<span style=background-color:#fff0f0>&#39;data&#39;</span>, (chunk) =&gt; {
    <span style=color:#080;font-weight:700>let</span> ok <span style=color:#333>=</span> writable.write(chunk);
    <span style=color:#888>// 背压，暂停
</span><span style=color:#888></span>    <span style=color:#333>!</span>ok <span style=color:#333>&amp;&amp;</span> <span style=color:#080;font-weight:700>this</span>.pause();
  });
  writable.on(<span style=background-color:#fff0f0>&#39;drain&#39;</span>, () =&gt; {
    <span style=color:#888>// 恢复
</span><span style=color:#888></span>    <span style=color:#080;font-weight:700>this</span>.resume();
  });
  <span style=color:#888>// 告诉 writable 有流要导入
</span><span style=color:#888></span>  writable.emit(<span style=background-color:#fff0f0>&#39;pipe&#39;</span>, <span style=color:#080;font-weight:700>this</span>);
  <span style=color:#888>// 支持链式调用
</span><span style=color:#888></span>  <span style=color:#080;font-weight:700>return</span> writable;
};
</code></pre></div><p>2 Follow Guys：</p><p><a href=https://github.com/substack>substack</a>
<a href=https://github.com/nodejs/readable-stream>https://github.com/nodejs/readable-stream</a></p><p>3 Understand the concept of streams by <a href="https://blog.insiderattack.net/a-visual-guide-to-nodejs-streams-9d2d594a9bf5?gi=5c2a70f05af9">Visualize</a></p><h2 id=references>References<a href=#references class=hanchor arialabel=Anchor> 🔗&#xFE0E;</a></h2><p><a href=https://nodejs.org/api/stream.html#stream>https://nodejs.org/api/stream.html#stream</a><br><a href=https://nodejs.dev/learn/nodejs-streams>https://nodejs.dev/learn/nodejs-streams</a><br><a href=https://nodesource.com/blog/understanding-streams-in-nodejs/>https://nodesource.com/blog/understanding-streams-in-nodejs/</a><br><a href=https://nodejs.org/api/stream.html>https://nodejs.org/api/stream.html</a><br><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array</a><br><a href=https://frontendmasters.com/courses/networking-streams/>https://frontendmasters.com/courses/networking-streams/</a></p></div><style type=text/css>#mc_embed_signup form{display:block;position:relative;text-align:left;padding:10px 0 10px 3%}#mc_embed_signup h2{font-weight:700;padding:0;margin:15px 0;font-size:1.4em}#mc_embed_signup input{border:1px solid #abb0b2;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px}#mc_embed_signup input[type=checkbox]{-webkit-appearance:checkbox}#mc_embed_signup input[type=radio]{-webkit-appearance:radio}#mc_embed_signup input:focus{border-color:#333}#mc_embed_signup .button{clear:both;background-color:#aaa;border:0;border-radius:4px;transition:all .23s ease-in-out 0s;color:#fff;cursor:pointer;display:inline-block;font-size:15px;font-weight:400;height:32px;line-height:32px;margin:0 5px 10px 0;padding:0 22px;text-align:center;text-decoration:none;vertical-align:top;white-space:nowrap;width:auto}#mc_embed_signup .button:hover{background-color:#777}#mc_embed_signup .small-meta{font-size:11px}#mc_embed_signup .nowrap{white-space:nowrap}#mc_embed_signup .mc-field-group{clear:left;position:relative;width:96%;padding-bottom:3%;min-height:50px}#mc_embed_signup .size1of2{clear:none;float:left;display:inline-block;width:46%;margin-right:4%}* html #mc_embed_signup .size1of2{margin-right:2%}#mc_embed_signup .mc-field-group label{display:block;margin-bottom:3px}#mc_embed_signup .mc-field-group input{display:block;width:100%;padding:8px 0;text-indent:2%}#mc_embed_signup .mc-field-group select{display:inline-block;width:99%;padding:5px 0;margin-bottom:2px}#mc_embed_signup .datefield,#mc_embed_signup .phonefield-us{padding:5px 0}#mc_embed_signup .datefield input,#mc_embed_signup .phonefield-us input{display:inline;width:60px;margin:0 2px;letter-spacing:1px;text-align:center;padding:5px 0 2px}#mc_embed_signup .phonefield-us .phonearea input,#mc_embed_signup .phonefield-us .phonedetail1 input{width:40px}#mc_embed_signup .datefield .monthfield input,#mc_embed_signup .datefield .dayfield input{width:30px}#mc_embed_signup .datefield label,#mc_embed_signup .phonefield-us label{display:none}#mc_embed_signup .indicates-required{text-align:right;font-size:11px;margin-right:4%}#mc_embed_signup .asterisk{color:#e85c41;font-size:150%;font-weight:400;position:relative;top:5px}#mc_embed_signup .clear{clear:both}#mc_embed_signup .mc-field-group.input-group ul{margin:0;padding:5px 0;list-style:none}#mc_embed_signup .mc-field-group.input-group ul li{display:block;padding:3px 0;margin:0}#mc_embed_signup .mc-field-group.input-group label{display:inline}#mc_embed_signup .mc-field-group.input-group input{display:inline;width:auto;border:none}#mc_embed_signup div#mce-responses{float:left;top:-1.4em;padding:0 .5em;overflow:hidden;width:90%;margin:0 5%;clear:both}#mc_embed_signup div.response{margin:1em 0;padding:1em .5em .5em 0;font-weight:700;float:left;top:-1.5em;z-index:1;width:80%}#mc_embed_signup #mce-error-response{display:none}#mc_embed_signup #mce-success-response{color:#529214;display:none}#mc_embed_signup label.error{display:block;float:none;width:auto;margin-left:1.05em;text-align:left;padding:.5em 0}#mc-embedded-subscribe{clear:both;width:auto;display:block;margin:1em 0 1em 5%}#mc_embed_signup #num-subscribers{font-size:1.1em}#mc_embed_signup #num-subscribers span{padding:.5em;border:1px solid #ccc;margin-right:.5em;font-weight:700}#mc_embed_signup #mc-embedded-subscribe-form div.mce_inline_error{display:inline-block;margin:2px 0 1em;padding:5px 10px;background-color:rgba(255,255,255,.85);-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;font-size:14px;font-weight:400;z-index:1;color:#e85c41}#mc_embed_signup #mc-embedded-subscribe-form input.mce_inline_error{border:2px solid #e85c41}.colorscheme-dark #mc_embed_signup{background:#212121;border:1px solid}.colorscheme-dark input[type=email]{background:#181818;color:silver}#mc_embed_signup{background:#fff;clear:left;font:14px Helvetica,Arial,sans-serif}</style><div id=mc_embed_signup><form action="https://gmail.us5.list-manage.com/subscribe/post?u=c3b0164459768548b7bef380c&amp;id=1103acd526" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><h3 style=text-align:center>当发布很酷的东西时，请第一时间通知我</h3><p style=text-align:center>订阅电子邮件，以获得我的最新文章。</p><div class=mc-field-group><label for=mce-EMAIL>邮箱地址 <span class=asterisk>*</span></label>
<input type=email name=EMAIL class="required email" id=mce-EMAIL></div><div id=mce-responses class=clear><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_c3b0164459768548b7bef380c_1103acd526 tabindex=-1></div><div class=clear><input type=submit value=订阅 name=subscribe id=mc-embedded-subscribe class=button></div></div></form></div><script type=text/javascript src=//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js></script><script type=text/javascript>(function($){window.fnames=new Array();window.ftypes=new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj=jQuery.noConflict(true);</script><section class=social-sharing><h4>分享到</h4><a href="https://twitter.com/intent/tweet?via=maoxunxing&text=NodeJS%20Stream%20from%20Beginner%20to%20Master%20https%3a%2f%2fmaoxunxing.com%2fzh-cn%2fnodejs-network-stream%2f" class="btn btn-twitter btn-social" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden=true></i><span>Twitter</span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmaoxunxing.com%2fzh-cn%2fnodejs-network-stream%2f" class="btn btn-facebook btn-social" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden=true></i><span>Facebook</span></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmaoxunxing.com%2fzh-cn%2fnodejs-network-stream%2f" class="btn btn-linkedin btn-social" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden=true></i><span>LinkedIn</span></a></section><style>.utterances{max-width:initial!important;margin-top:40px}</style><script src=https://utteranc.es/client.js repo=XingMXTeam/XingMXTeam.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script><script>talkyardServerUrl='';talkyardLogLevel='warn';</script><script async defer src></script><section><div class=talkyard-comments data-discussion-id style=margin-top:45px><noscript>Please enable JavaScript to view comments.</noscript></div></section><footer></footer></article></section></div><footer class=footer><section class=container><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/ style=color:inherit>CC BY-NC-SA 4.0</a>
2022
©
Xunxing Mao</section></footer></main><script src=https://maoxunxing.com/js/coder.min.158f22d7bc754e28d7c61accc0aef7952c2b949889ec9503466e5d4db0548808.js integrity="sha256-FY8i17x1TijXxhrMwK73lSwrlJiJ7JUDRm5dTbBUiAg="></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-199510588-1','auto');ga('require','outboundLinkTracker');ga('send','pageview');</script><script src=https://www.google-analytics.com/analytics.js async></script><script src=https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js async></script><script type=module>
    // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDRvV151FcMlUQq5-5zUqaR1BHJ8RhwkTw",
    authDomain: "blog-6a0bf.firebaseapp.com",
    projectId: "blog-6a0bf",
    storageBucket: "blog-6a0bf.appspot.com",
    messagingSenderId: "379181681011",
    appId: "1:379181681011:web:cb9abcf9cfb01c2f181d06",
    measurementId: "G-65M6Z03PV2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script><script>if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js',{scope:'/'}).then(function(registration){});navigator.serviceWorker.ready.then(function(registration){});}</script></body></html>